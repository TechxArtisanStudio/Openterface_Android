name: Openterface Build & Package

on:
  push:
    branches:
      - 'main'
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties

    - name: Decode Keystore
      env:
        ENCODED_STRING: ${{ secrets.SIGNING_KEY }}
      run: |
        echo $ENCODED_STRING | base64 -di > app/keystore.jks
        echo "Keystore file created: app/keystore.jks"
        ls -lh app/keystore.jks

    - name: Verify Keystore
      env:
        SIGNING_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        SIGNING_KEY_ALIAS: ${{ secrets.ALIAS }}
      run: |
        echo "Verifying keystore can be read..."
        echo "Listing all aliases in keystore:"
        keytool -list -keystore app/keystore.jks -storepass "$SIGNING_STORE_PASSWORD" || {
          echo "❌ Error: Cannot read keystore with store password"
          echo "This means KEY_STORE_PASSWORD is incorrect"
          exit 1
        }
        echo ""
        echo "Verifying specific alias: $SIGNING_KEY_ALIAS"
        keytool -list -keystore app/keystore.jks -storepass "$SIGNING_STORE_PASSWORD" -alias "$SIGNING_KEY_ALIAS" || {
          echo "❌ Error: Alias '$SIGNING_KEY_ALIAS' does not exist in keystore"
          echo "Please check the ALIAS secret in GitHub"
          echo "Available aliases are listed above"
          exit 1
        }
        echo "✅ Keystore verified successfully!"

    - name: Clean Gradle
      run: ./gradlew clean

    - name: Build Release APK
      run: ./gradlew assembleRelease -x lint --info
      env:
        SIGNING_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        SIGNING_KEY_ALIAS: ${{ secrets.ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    - name: Build Release AAB
      run: ./gradlew bundleRelease -x lint --info
      env:
        SIGNING_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
        SIGNING_KEY_ALIAS: ${{ secrets.ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    # Verify signing
    - name: Verify APK Signature
      run: |
        echo "Verifying APK signature..."
        jarsigner -verify -verbose -certs app/build/outputs/apk/release/*.apk | grep "SHA"
      continue-on-error: true

    - name: Verify AAB Signature
      run: |
        echo "Verifying AAB signature..."
        jarsigner -verify -verbose -certs app/build/outputs/bundle/release/*.aab | grep "SHA"
      continue-on-error: true

    # Get version info
    - name: Get Version Info
      id: version
      run: |
        VERSION_NAME=$(grep "versionName" app/build.gradle | awk '{print $2}' | tr -d '"')
        VERSION_CODE=$(grep "versionCode" app/build.gradle | awk '{print $2}')
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "Version: $VERSION_NAME ($VERSION_CODE)"

    # Rename files with version
    - name: Rename Release Files
      run: |
        cd app/build/outputs/apk/release
        for file in *.apk; do
          mv "$file" "Openterface-v${{ steps.version.outputs.version_name }}-release.apk"
        done
        cd ../../../bundle/release
        for file in *.aab; do
          mv "$file" "Openterface-v${{ steps.version.outputs.version_name }}-release.aab"
        done

    # Store signed release APK files as artifacts
    - name: Upload Signed Release APK
      uses: actions/upload-artifact@v4
      with:
        name: Openterface-v${{ steps.version.outputs.version_name }}-APK
        path: |
          app/build/outputs/apk/release/*.apk
        retention-days: 90

    # Store signed release AAB files as artifacts
    - name: Upload Signed Release AAB
      uses: actions/upload-artifact@v4
      with:
        name: Openterface-v${{ steps.version.outputs.version_name }}-AAB
        path: |
          app/build/outputs/bundle/release/*.aab
        retention-days: 90

    # Create build summary
    - name: Build Summary
      run: |
        echo "## 🎉 Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📦 Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version Name**: ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Version Code**: ${{ steps.version.outputs.version_code }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📱 Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ APK: Openterface-v${{ steps.version.outputs.version_name }}-release.apk" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ AAB: Openterface-v${{ steps.version.outputs.version_name }}-release.aab" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🔐 Signing" >> $GITHUB_STEP_SUMMARY
        echo "Both APK and AAB are signed with the release keystore" >> $GITHUB_STEP_SUMMARY